name: Weekly GoFish Summary
on:
  schedule:
    - cron: "0 14 * * 5" # Fridays at 2pm UTC (adjust to your timezone)
  workflow_dispatch: # Allow manual triggers
    inputs:
      dry_run:
        description: "Dry run mode (skip Slack posting, output to logs)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  summarize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git log

      - name: Get date range
        id: dates
        run: |
          echo "week_ago=$(date -d '7 days ago' +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "today=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Get merged PRs from last week
        id: prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRS=$(gh pr list \
            --state merged \
            --search "merged:>=${{ steps.dates.outputs.week_ago }}" \
            --json number,title,body,author,mergedAt,url \
            --jq '.[] | "### PR #\(.number): \(.title)\n- **Author:** \(.author.login)\n- **Merged:** \(.mergedAt[:10])\n- **URL:** \(.url)\n- **Description:** \(.body // "No description" | split("\n")[0:3] | join(" ") | .[0:300])\n"')
          if [ -z "$PRS" ]; then
            PRS="No PRs merged this week."
          fi
          # Store in file to avoid escaping issues
          echo "$PRS" > prs.txt

      - name: Summarize with Claude
        id: summary
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          bash .github/scripts/summarize-with-claude.sh

      - name: Display summary (always shown)
        run: |
          echo "## ðŸ“‹ Generated Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat summary.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          # Also output to console for easy viewing
          echo "=========================================="
          echo "GENERATED SUMMARY:"
          echo "=========================================="
          cat summary.txt
          echo "=========================================="

      - name: Post to Slack
        if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.dry_run != 'true') }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.GOFISH_SLACK_CHANNEL_WEBHOOK_URL }}
        run: |
          SUMMARY=$(cat summary.txt)

          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âš ï¸  SLACK_WEBHOOK_URL secret not set. Skipping Slack post."
            exit 0
          fi

          # Build Slack payload with proper escaping
          jq -n \
            --arg text "ðŸŸ *GoFish Weekly Update* (${{ steps.dates.outputs.week_ago }} â†’ ${{ steps.dates.outputs.today }})" \
            --arg summary "$SUMMARY" \
            '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸŸ GoFish Weekly Update",
                    "emoji": true
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": $text | split("*") | join("")
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": $summary
                  }
                }
              ]
            }' > payload.json

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @payload.json

      - name: Dry run notice
        if: ${{ inputs.dry_run == 'true' }}
        run: |
          echo "âœ… DRY RUN MODE: Summary generated but NOT posted to Slack"
          echo "To post to Slack, run the workflow with dry_run set to 'false'"
